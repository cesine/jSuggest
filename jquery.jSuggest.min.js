(function(d){d.fn.jSuggest=function(r){var a=d.extend({source:{},uniqID:!1,startText:"Enter a Value",emptyText:"No Results Found",repeatText:"Inserting the same value twice is not allowed",loadingText:"Loading...",preFill:{},limitText:"No More Values Are Allowed",newItem:!1,newText:"Adding New Values Is Not Allowed",selectedItemProp:"value",selectProp:"value",seekVal:"value",queryParam:"q",queryLimit:!1,extraParams:"",matchCase:!1,minChars:1,keyDelay:400,resultsHighlight:!0,selectionLimit:!1,showResultList:!0, selectionClick:function(){},selectionAdded:function(){},selectionRemoved:function(a){a.remove()},spotFirst:!0,formatList:!1,beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultClick:function(){},resultsComplete:function(){}},r),x=typeof a.source;return this.each(function(b){function v(){if(46==lastKey||9<lastKey&&32>lastKey)return f.hide();var c=d.trim(e.val()).replace(/[\\]+|[\/]+/g,"").replace(/\s+/g," ");if(c.length>=a.minChars)if(a.beforeRetrieve&&(c=a.beforeRetrieve.call(this, c)),g.addClass("loading"),j.html('<li class="as-message">'+a.loadingText+"</li>").show(),f.show(),"string"===x){var b=q?"&limit="+encodeURIComponent(q):"";d.getJSON(a.source+"?"+a.queryParam+"="+encodeURIComponent(c)+b+a.extraParams,function(a){w(a,c)})}else w(a.source,c);else g.removeClass("loading"),f.hide()}function r(c,b,y){var p=0,h,k,i;f.html(j.html("")).hide();for(var l=0;l<y;l++){h=l;k="";for(var n=a.seekVal.split(","),m=0;m<n.length;m++)i=d.trim(n[m]),k+=c[h][i];a.matchCase||(k=k.toLowerCase(), b=b.toLowerCase());if(-1!==k.search(b)&&-1===o.val().search(c[h][a.selectProp]+",")&&(k=d('<li class="as-result-item" id="as-result-item-'+h+'"></li>').click(function(){var c=d(this).data("data"),b=c.num,h=c.attributes;e.val("").focus();s(h,b);a.resultClick.call(this,c);f.hide()}).mouseover(function(){d("li",j).removeClass("active");d(this).addClass("active")}).data("data",{attributes:c[h],num:h}),h=d.extend({},c[h]),i=RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)",""+(!a.matchCase? "gi":"g")+""),a.resultsHighlight&&(h[a.selectedItemProp]=h[a.selectedItemProp].replace(i,"<em>$1</em>")),k=!a.formatList?k.html(h[a.selectedItemProp]):a.formatList.call(this,h,k),j.append(k),p++,q&&q==p))break}g.removeClass("loading");t=!0;0>=p&&j.html('<li class="as-message">'+a.emptyText+"</li>");f.show();a.spotFirst&&u("down");a.resultsComplete.call(this)}function s(c,b){o.val(o.val()+c[a.selectProp]+",");var f=d('<li class="as-selection-item" id="as-selection-'+b+'"></li>').click(function(){a.selectionClick.call(this, d(this),c);g.children().removeClass("selected");d(this).data(c).addClass("selected")}).data("js-data",c),p=d('<a class="as-close">x</a>').click(function(){o.val(o.val().replace(c[a.selectProp]+",",""));a.selectionRemoved.call(this,f,c);e.focus();return!1});i.before(f.html(c[a.selectedItemProp]).prepend(p));a.selectionAdded.call(this,i.prev(),c)}function u(a){if(0<d(":visible",f).length){var b=d("li",f),e="down"===a?b.eq(0):b.filter(":last"),g=d("li.active:first",f);0<g.length&&(e="down"===a?g.next(): g.prev());b.removeClass("active");e.addClass("active")}}function w(c,d){var b=0,e=a.retrieveComplete.call(this,c),f;for(f in e)e.hasOwnProperty(f)&&b++;r(e,d,b)}var b=!a.uniqID?b+""+Math.floor(100*Math.random()):b=a.uniqID,z=!a.uniqID?"as-input-"+b:b,e=d(this);e.attr("autocomplete","off").addClass("as-input").attr("id",z).val(a.startText);e.wrap('<ul class="as-selections" id="as-selections-'+b+'"></ul>').wrap('<li class="as-original" id="as-original-'+b+'"></li>');var g=d("#as-selections-"+b),i=d("#as-original-"+ b),f=d('<div class="as-results" id="as-results-'+b+'"></div>').hide(),j=d('<ul class="as-list"></ul>').css("width",g.outerWidth()).appendTo(f),o=d('<input type="hidden" class="as-values" name="as_values_'+b+'" id="as-values-'+b+'" />'),q=a.queryLimit,l=a.selectionLimit,t=!1,m=null;if("object"===typeof a.preFill){var b=0,n;for(n in a.preFill)a.preFill.hasOwnProperty(n)&&b++;if(0<b){l&&b>=l&&(b=l);for(n=0;n<b;n++)s(a.preFill[n],"000"+n);d("li.as-selection-item",g).addClass("blur").removeClass("selected"); e.val("").width(30)}}e.after(o);g.click(function(){e.focus()}).after(f);e.focus(function(){e.val()===a.startText&&""===o.val()&&e.val("");d("li.as-selection-item",g).removeClass("blur");""!==d.trim(e.val())&&f.show()}).blur(function(){""===e.val()&&""===o.val()&&e.val(a.startText);e.width(8*e.val().length+30);f.is(":hover")||(d("li.as-selection-item",g).addClass("blur").removeClass("selected"),f.hide())}).keydown(function(c){lastKey=c.keyCode;switch(lastKey){case 38:case 40:c.preventDefault();38=== lastKey?u("up"):u("down");break;case 8:""===e.val()&&(g.children().not(i.prev()).removeClass("selected"),i.prev().hasClass("selected")?i.prev().find(".as-close").click():(a.selectionClick.call(this,i.prev(),i.prev().data("js-data")),i.prev().addClass("selected")));1===e.val().length&&f.hide();m&&clearTimeout(m);m=setTimeout(function(){v()},a.keyDelay);break;case 9:case 188:case 13:c.preventDefault();c=d.trim(e.val()).replace(/(,)/g,"");if(""!==c&&0>o.val().search(c+",")&&c.length>=a.minChars)if((9=== lastKey||13===lastKey)&&0<d("li.as-result-item:visible",f).length&&0<d("li.active:first",j).length)d("li.active:first",j).click();else if(a.newItem){if(t)if(t=!1,l&&d("li",g).length<=l){var c=a.newItem.call(this,c),b=d("li",g).length;s(c,"00"+(b+1));f.hide();e.val("")}else j.html('<li class="as-message">'+a.limitText+"</li>").show()}else j.html('<li class="as-message">'+a.newText+"</li>").show();else j.html('<li class="as-message">'+a.repeatText+"</li>").show();break;default:l&&d("li.as-selection-item", g).length>=l?(j.html('<li class="as-message">'+a.limitText+"</li>"),f.show()):(m&&clearTimeout(m),m=setTimeout(function(){v()},a.keyDelay))}}).keyup(function(){e.width(8*e.val().length+30)})})}})(jQuery);